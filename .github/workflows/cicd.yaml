# .github/workflows/tofu.yml
name: 'TOFU GKE and ArgoCD Deploy'

on:
  push:
    branches:
      - main
      - develop
      - 'gke-demos'

jobs:
  tofu:
    name: 'TOFU Apply'
    runs-on: ubuntu-latest

    env:
      TOFU_ENV: ${{ github.ref_name == 'main' && 'prod' || github.ref_name == 'develop' && 'stage' || 'sandbox' }}
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/key.json
    
    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v3

    - name: 'Set up Google Cloud SDK'
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
    
    - name: 'Create service account key file'
      run: |
        echo "${{ secrets.GCP_SA_KEY }}" > $GOOGLE_APPLICATION_CREDENTIALS

        # Debug: Check if the JSON is valid
        if ! jq empty $GOOGLE_APPLICATION_CREDENTIALS; then
          echo "Invalid JSON in key.json"
          exit 1
        fi


    - name: 'Set up OpenTofu'
      uses: opentofu/setup-opentofu@v1

    - name: 'TOFU Format Check'
      run: |
        echo "Running TOFU fmt..."
        tofu fmt -check

    - name: 'TOFU Init with Partial Backend Configuration'
      run: |
        echo "Initializing TOFU..."
        env
        tofu init -backend-config="bucket=${{ secrets.GCS_BUCKET_NAME }}" \
                  -backend-config="prefix=tofu/state/${{ env.TOFU_ENV }}" \
                  -backend-config="credentials=${{ env.GOOGLE_APPLICATION_CREDENTIALS }}"

    - name: 'TOFU Plan'
      run: |
        echo "Running TOFU plan for environment: ${{ env.TOFU_ENV }}"
        tofu plan -var-file="${{ env.TOFU_ENV }}.tfvars" -out=tfplan

    - name: 'TOFU Apply'
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      run: |
        echo "Applying TOFU changes for environment: ${{ env.TOFU_ENV }}"
        # tofu apply tfplan